#include "sensor.h"

/* Start of autogenerated OD accessors */

/* End of autogenerated OD accessors */

static ODR_t OD_write_device_sensor_property(OD_stream_t *stream, const void *buf, OD_size_t count,
                                             OD_size_t *countWritten) {
    device_sensor_t *sensor = stream->object;
    (void)sensor;
    ODR_t result = OD_writeOriginal(stream, buf, count, countWritten);
    return result;
}

static int device_sensor_validate(OD_entry_t *config_entry) {
    device_sensor_config_t *config = (device_sensor_config_t *)OD_getPtr(config_entry, 0x01, 0, NULL);
    (void)config;
    if (false) {
        return CO_ERROR_OD_PARAMETERS;
    }
    return 0;
}

static int device_sensor_construct(device_sensor_t *sensor, device_t *device) {
    sensor->device = device;
    sensor->config = (device_sensor_config_t *)OD_getPtr(device->config, 0x01, 0, NULL);
    return sensor->config->disabled;
}

static int device_sensor_start(device_sensor_t *sensor) {
    (void)sensor;
    return 0;
}

static int device_sensor_stop(device_sensor_t *sensor) {
    (void)sensor;
    return 0;
}

static int device_sensor_pause(device_sensor_t *sensor) {
    (void)sensor;
    return 0;
}

static int device_sensor_resume(device_sensor_t *sensor) {
    (void)sensor;
    return 0;
}

static int device_sensor_tick(device_sensor_t *sensor, uint32_t time_passed, uint32_t *next_tick) {
    (void)sensor;
    (void)time_passed;
    (void)next_tick;
    return 0;
}

// pass over adc value to the linked device
static int device_sensor_receive(device_sensor_t *sensor, device_t *device, void *value, void *channel) {
    (void) channel; /*unused*/
    if (sensor->adc->device == device) {
        sensor->target_device->callbacks->receive(sensor->target_device->object, sensor->device, value,
                                                  sensor->target_argument);
    }
    return 0;
}

static int device_sensor_link(device_sensor_t *sensor) {
    return device_link(sensor->device, (void **)&sensor->adc, sensor->config->adc_index, (void *) (uint32_t) sensor->config->adc_channel);
}

static int device_sensor_accept(device_sensor_t *sensor, device_t *target, void *argument) {
    sensor->target_device = target;
    sensor->target_argument = argument;
    return 0;
}

static int device_sensor_phase(device_sensor_t *sensor, device_phase_t phase) {
    (void)sensor;
    (void)phase;
    return 0;
}

device_callbacks_t device_sensor_callbacks = {
    .validate = device_sensor_validate,
    .construct = (int (*)(void *, device_t *))device_sensor_construct,
    .link = (int (*)(void *))device_sensor_link,
    .start = (int (*)(void *))device_sensor_start,
    .stop = (int (*)(void *))device_sensor_stop,
    .pause = (int (*)(void *))device_sensor_pause,
    .resume = (int (*)(void *))device_sensor_resume,
    .tick = (int (*)(void *, uint32_t time_passed, uint32_t *next_tick))device_sensor_tick,
    .receive = (int (*)(void *, device_t *device, void *value, void *channel))device_sensor_receive,
    .accept = (int (*)(void *, device_t *device, void *channel))device_sensor_accept,
    .phase = (int (*)(void *, device_phase_t phase))device_sensor_phase,
    .write_values = OD_write_device_sensor_property};
