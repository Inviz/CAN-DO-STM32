#include "sensor.h"

/* Start of autogenerated OD accessors */
OD_ACCESSORS(input, sensor, values, disabled, SUBIDX_SENSOR_DISABLED, uint16_t, u16) /* 0x88XX01: values */
OD_ACCESSORS(input, sensor, values, port, SUBIDX_SENSOR_PORT, uint8_t, u8) /* 0x88XX02: values */
OD_ACCESSORS(input, sensor, values, pin, SUBIDX_SENSOR_PIN, uint8_t, u8) /* 0x88XX03: values */
OD_ACCESSORS(input, sensor, values, adc_index, SUBIDX_SENSOR_ADC_INDEX, uint16_t, u16) /* 0x88XX04: values */
OD_ACCESSORS(input, sensor, values, adc_channel, SUBIDX_SENSOR_ADC_CHANNEL, uint8_t, u8) /* 0x88XX05: values */
/* End of autogenerated OD accessors */

static ODR_t OD_write_input_sensor_property(OD_stream_t *stream, const void *buf, OD_size_t count,
                                             OD_size_t *countWritten) {
    input_sensor_t *sensor = stream->object;
    (void)sensor;
    ODR_t result = OD_writeOriginal(stream, buf, count, countWritten);
    return result;
}

static int input_sensor_validate(OD_entry_t *config_entry) {
    input_sensor_config_t *config = (input_sensor_config_t *)OD_getPtr(config_entry, 0x01, 0, NULL);
    (void)config;
    if (false) {
        return CO_ERROR_OD_PARAMETERS;
    }
    return 0;
}

static int input_sensor_construct(input_sensor_t *sensor, device_t *device) {
    sensor->device = device;
    sensor->config = (input_sensor_config_t *)OD_getPtr(device->config, 0x01, 0, NULL);
    return sensor->config->disabled;
}

static int input_sensor_start(input_sensor_t *sensor) {
    (void)sensor;
    return 0;
}

static int input_sensor_stop(input_sensor_t *sensor) {
    (void)sensor;
    return 0;
}

static int input_sensor_pause(input_sensor_t *sensor) {
    (void)sensor;
    return 0;
}

static int input_sensor_resume(input_sensor_t *sensor) {
    (void)sensor;
    return 0;
}


// pass over adc value to the linked device
static int input_sensor_receive(input_sensor_t *sensor, device_t *device, void *value, void *channel) {
    (void) channel; /*unused*/
    if (sensor->adc->device == device) {
        device_send(sensor->device, sensor->target_device, value, sensor->target_argument);
    }
    return 0;
}

static int input_sensor_link(input_sensor_t *sensor) {
    return device_link(sensor->device, (void **)&sensor->adc, sensor->config->adc_index, (void *) (uint32_t) sensor->config->adc_channel);
}

static int input_sensor_accept(input_sensor_t *sensor, device_t *target, void *argument) {
    sensor->target_device = target;
    sensor->target_argument = argument;
    return 0;
}

static int input_sensor_phase(input_sensor_t *sensor, device_phase_t phase) {
    (void)sensor;
    (void)phase;
    return 0;
}

device_callbacks_t input_sensor_callbacks = {
    .validate = input_sensor_validate,
    .construct = (int (*)(void *, device_t *))input_sensor_construct,
    .link = (int (*)(void *))input_sensor_link,
    .start = (int (*)(void *))input_sensor_start,
    .stop = (int (*)(void *))input_sensor_stop,
    .pause = (int (*)(void *))input_sensor_pause,
    .resume = (int (*)(void *))input_sensor_resume,
    .receive = (int (*)(void *, device_t *device, void *value, void *channel))input_sensor_receive,
    .accept = (int (*)(void *, device_t *device, void *channel))input_sensor_accept,
    .phase = (int (*)(void *, device_phase_t phase))input_sensor_phase,
    .write_values = OD_write_input_sensor_property};
